#
# Copyright (c) 2017 ISPRAS (http://www.ispras.ru)
# Institute for System Programming of the Russian Academy of Sciences
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

import os
import subprocess


PYTHON_VERSION = '3.6.1'


class Cd:
    def __init__(self, path):
        self.new_path = path

    def __enter__(self):
        self.prev_path = os.getcwd()
        os.chdir(self.new_path)

    def __exit__(self, etype, value, traceback):
        os.chdir(self.prev_path)


def execute_cmd(*args):
    print('Execute command "{0}"'.format(' '.join(args)))
    subprocess.check_call(args)


print('Install RPM packages')
execute_cmd(
    'zypper', 'install', '-y',
    # For Python.
    'make', 'gcc', 'gdbm-devel', 'libbz2-devel', 'libopenssl-devel', 'readline-devel', 'sqlite3-devel', 'tk-devel',
    'xz-devel', 'zlib-devel',
    # For Klever Bridge.
    'nginx', 'postgresql',
    # For Klever Core.
    'graphviz',
    # For building the Linux kernel.
    'glibc-devel-32bit',
    # For CPAchecker 1.6+.
    'java-1_8_0-openjdk-headless'
)

print('Install Python')
execute_cmd('wget', '-q', 'https://www.python.org/ftp/python/{0}/Python-{0}.tar.xz'.format(PYTHON_VERSION))
execute_cmd('tar', '-xf', 'Python-{0}.tar.xz'.format(PYTHON_VERSION))
with Cd('Python-{0}'.format(PYTHON_VERSION)):
    # TODO: --enable-optimizations takes very much time but likely speeds up Python slightly.
    execute_cmd('./configure')
    execute_cmd('make', '-j8')
    execute_cmd('make', 'install')
execute_cmd('rm', '-rf', 'Python-{0}*'.format(PYTHON_VERSION))

print('Install Python packages')
execute_cmd(
    'pip3', 'install', '-U',
    # For Klever Bridge.
    'Django', 'gunicorn', 'psycopg2', 'pytz',
    # For Klever Core.
    'jinja2', 'graphviz', 'ply', 'requests', 'setuptools_scm',
    # For Klever Scheduler.
    'consulate'
)
