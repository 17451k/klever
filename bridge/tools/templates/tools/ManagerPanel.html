{% extends 'bridge/base.html' %}
{% comment "License" %}
% Copyright (c) 2018 ISP RAS (http://www.ispras.ru)
% Ivannikov Institute for System Programming of the Russian Academy of Sciences
%
% Licensed under the Apache License, Version 2.0 (the "License");
% you may not use this file except in compliance with the License.
% You may obtain a copy of the License at
%
%    http://www.apache.org/licenses/LICENSE-2.0
%
% Unless required by applicable law or agreed to in writing, software
% distributed under the License is distributed on an "AS IS" BASIS,
% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
% See the License for the specific language governing permissions and
% limitations under the License.
{% endcomment %}

{% load i18n %}
{% load staticfiles %}

{% block title %}{% trans 'Manager Tools' %}{% endblock %}

{% block head_block %}
    <script src="{% static 'tools/js/manager.js' %}"></script>
{% endblock %}

{% block body_block %}
    <div class="ui grid">
        <div class="eight wide column">
            <div id="recalc_for_all_jobs_checkbox" class="ui checkbox">
                <input id="recalc_for_all_jobs" type="checkbox">
                <label for="recalc_for_all_jobs"><b>{% trans 'Jobs' %}</b><i class="ui help blue icon"></i></label>
            </div>
            <div style="overflow: auto;margin-top: 15px;">
                <table class="ui compact violet table celled">
                    <thead>
                        <tr>
                            <th>{% trans 'Name' %}</th>
                            <th>{% trans 'Identifier' %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs %}
                            <tr class="one wide column">
                                <td>
                                    <div class="ui checkbox">
                                        <input id="job__{{ job.pk }}" name="job" type="checkbox" value="{{ job.pk }}">
                                        <label for="job__{{ job.pk }}">{{ job.name }}</label>
                                    </div>
                                </td>
                                <td>{{ job.identifier }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="four wide column">
            <p><b>{% trans 'Cache recalculation' %}:</b></p>
            <div class="ui vertical buttons">
                <button class="ui orange button recalc-button" data-value="leaves">{% trans 'Reports leaves' %}</button>
                <button class="ui orange button recalc-button" data-value="safe_links">{% trans 'Safe associations' %}</button>
                <button class="ui orange button recalc-button" data-value="unsafe_links">{% trans 'Unsafe associations' %}</button>
                <button class="ui orange button recalc-button" data-value="unknown_links">{% trans 'Unknown associations' %}</button>
                <button class="ui orange button recalc-button" data-value="safe_reports">{% trans 'Safe reports' %}</button>
                <button class="ui orange button recalc-button" data-value="unsafe_reports">{% trans 'Unsafe reports' %}</button>
                <button class="ui orange button recalc-button" data-value="unknown_reports">{% trans 'Unknown reports' %}</button>
                <button class="ui orange button recalc-button" data-value="resources">{% trans 'Resources' %}</button>
                <button class="ui orange button recalc-button" data-value="compinst">{% trans 'Components instances' %}</button>
                <button class="ui orange button recalc-button" data-value="coverage">{% trans 'Coverage' %}</button>
                <button class="ui red button recalc-button" data-value="all">{% trans 'All caches' %}</button>
            </div>
        </div>
        <div class="four wide column right aligned">
            <div class="ui vertical buttons">
                <button class="ui orange button recalc-marks-button" data-value="safe">{% trans 'Recalculate safe marks cache' %}</button>
                <button class="ui orange button recalc-marks-button" data-value="unsafe">{% trans 'Recalculate unsafe marks cache' %}</button>
                <button class="ui orange button recalc-marks-button" data-value="unknown">{% trans 'Recalculate unknown marks cache' %}</button>
                <a href="{% url 'marks:api-download-all' %}" class="ui teal button">{% trans 'Download all marks' %}</a>
                <button id="upload_all_marks" class="ui teal button">{% trans 'Upload all marks' %}</button>
                <button class="ui red button api-request-btn" data-url="{% url 'tools:api-clear-system' %}" data-method="POST">{% trans 'Remove unused files and DB rows' %}</button>
                <button class="ui red button api-request-btn" data-url="{% url 'tools:api-clear-tasks' %}" data-method="DELETE">{% trans 'Remove tasks for not solving jobs' %}</button>
                <a href="{% url 'tools:processing-list' %}" class="ui yellow button">{% trans 'View processing reqeusts' %}</a>
                <a href="{% url 'tools:call-logs' %}" class="ui yellow button">{% trans 'View function call logs' %}</a>
                <button class="ui yellow button api-request-btn" data-url="{% url 'tools:api-clear-logs' %}" data-method="DELETE">{% trans 'Remove call log that is older than 30 days' %}</button>
            </div>
        </div>
    </div>

    <div id="upload_all_marks_modal" class="ui modal">
        <div class="header">{% trans 'Upload marks' %}</div>
        <div class="content">
            <div class="ui checkbox">
                <input id="delete_marks_before_upload" type="checkbox">
                <label for="delete_marks_before_upload">{% trans 'Delete all marks before upload' %}</label>
            </div>
            <br><br>
            <div class="ui grid">
                <div class="four wide column right aligned">
                    <span class="ui violet button btn-file">{% trans 'Browse' %}<input id="upload_all_marks_file_input" type="file"></span>
                </div>
                <div class="twelve wide column">
                    <span id="upload_all_marks_filename" class="italic"></span>
                </div>
            </div>
        </div>
        <div class="actions">
            <button class="ui positive left button modal-confirm" data-url="{% url 'marks:upload-all' %}">{% trans 'Upload' %}</button>
            <button class="ui blue button modal-cancel">{% trans 'Cancel' %}</button>
        </div>
    </div>

    <div id="uploaded_marks_modal" class="ui modal">
        <div class="header">{% trans 'Uploaded marks' %}</div>
        <div class="content">
            <h5 class="ui orange header">{% trans 'Unsafe' %}: <span id="num_uploaded_unsafe_marks"></span></h5>
            <h5 class="ui green header">{% trans 'Safe' %}: <span id="num_uploaded_safe_marks"></span></h5>
            <h5 class="ui red header">{% trans 'Unknown' %}: <span id="num_uploaded_unknown_marks"></span></h5>
            <h5 class="ui purple header">{% trans 'Failed' %}: <span id="num_uploaded_fail_marks"></span></h5>
        </div>
        <div class="actions">
            <button class="ui blue button modal-cancel">{% trans 'OK' %}</button>
        </div>
    </div>

    <script type="application/javascript">
        jQuery(function () {
            // Recalculate jobs caches
            $('.recalc-button').click(function () {
                let data = {'jobs': [], 'type': $(this).data('value')};
                $('input[name="job"]:checked').each(function () {
                    data['jobs'].push($(this).val());
                });
                if (!data['jobs'].length) return err_notify("{% trans 'Please select at least one job' %}");

                $('#dimmer_of_page').addClass('active');
                $.ajax({
                    url: "{% url 'tools:api-recalc' %}",
                    type: 'POST',
                    data: JSON.stringify(data),
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    success: function () {
                        $('#dimmer_of_page').removeClass('active');
                        success_notify("{% trans 'Caches were successfully recalculated' %}");
                    }
                });
            });

            // Recalculate marks caches
            $('.recalc-marks-button').click(function () {
                $('#dimmer_of_page').addClass('active');
                $.ajax({
                    url: "{% url 'tools:api-recalc-marks' %}",
                    type: 'POST',
                    data: {"type": $(this).data('value')},
                    success: function () {
                        $('#dimmer_of_page').removeClass('active');
                        success_notify("{% trans 'Marks caches were successfully recalculated' %}");
                    }
                });
            });
        })
    </script>
{% endblock %}
