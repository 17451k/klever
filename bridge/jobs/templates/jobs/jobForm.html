{% extends 'bridge/base.html' %}
{% comment "License" %}
% Copyright (c) 2019 ISP RAS (http://www.ispras.ru)
% Ivannikov Institute for System Programming of the Russian Academy of Sciences
%
% Licensed under the Apache License, Version 2.0 (the "License");
% you may not use this file except in compliance with the License.
% You may obtain a copy of the License at
%
%    http://www.apache.org/licenses/LICENSE-2.0
%
% Unless required by applicable law or agreed to in writing, software
% distributed under the License is distributed on an "AS IS" BASIS,
% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
% See the License for the specific language governing permissions and
% limitations under the License.
{% endcomment %}

{% load i18n %}
{% load staticfiles %}
{% load compress %}

{% block title %}{% if action == 'copy' %}{% trans 'Job Copying' %}{% elif action == 'create' %}{% trans 'Job Creating' %}{% else %}{% trans 'Job Editing' %}{% endif %}{% endblock %}

{% block head_block %}
    {# Code Mirror stylesheets #}
    {% compress css file codemirror %}
        <link rel="stylesheet" href="{% static 'bridge/codemirror/lib/codemirror.css' %}">
        <link rel="stylesheet" href="{% static 'bridge/codemirror/theme/midnight.css' %}">
        <link rel="stylesheet" href="{% static 'bridge/codemirror/addon/dialog/dialog.css' %}">
        <link rel="stylesheet" href="{% static 'bridge/codemirror/addon/search/matchesonscrollbar.css' %}">
    {% endcompress %}

    {# Code Mirror js libraries #}
    {% compress js file codemirror %}
        <script src="{% static 'bridge/codemirror/lib/codemirror.js' %}"></script>
        <script src="{% static 'bridge/codemirror/mode/javascript.js' %}"></script>
        <script src="{% static 'bridge/codemirror/mode/clike.js' %}"></script>
        <script src="{% static 'bridge/codemirror/mode/xml.js' %}"></script>
        <script src="{% static 'bridge/codemirror/mode/python.js' %}"></script>
        <script src="{% static 'bridge/codemirror/addon/dialog/dialog.js' %}"></script>
        <script src="{% static 'bridge/codemirror/addon/search/searchcursor.js' %}"></script>
        <script src="{% static 'bridge/codemirror/addon/scroll/annotatescrollbar.js' %}"></script>
        <script src="{% static 'bridge/codemirror/addon/search/matchesonscrollbar.js' %}"></script>
        <script src="{% static 'bridge/codemirror/addon/search/search.js' %}"></script>
    {% endcompress %}

    {# Jstree #}
    <link rel="stylesheet" href="{% static 'bridge/jstree/themes/default/style.min.css' %}">
    <script src="{% static 'bridge/jstree/jstree.min.js' %}"></script>

    {% compress js file jobform %}
        <script src="{% static 'jobs/js/jobFilesEdit.js' %}"></script>
        <script src="{% static 'jobs/js/jobRolesEdit.js' %}"></script>
        <script src="{% static 'jobs/js/jobForm.js' %}"></script>
    {% endcompress %}
{% endblock %}

{% block body_block %}
    <div class="ui grid">
        <div class="seven wide column">

            {# Versions #}
            {% if initial.id and initial.version and initial.versions %}
                {# Show versions only if job id, its current version and list of versions are provided #}
                <label for="job_version_selector" class="purple-title">{% trans 'Previous versions' %}</label>
                <select id="job_version_selector" class="ui dropdown fluid">
                    {% for jv in initial.versions %}
                        <option value="{% url 'jobs:api-job-version' initial.id jv.version %}"{% if jv.version == initial.version %} selected{% endif %}>{{ jv.title }}</option>
                    {% endfor %}
                </select>
                <br>
            {% endif %}

            {# Title and parent #}
            <div class="ui violet segment" style="margin-bottom: 0;">
                <label for="job_name"><strong>{% trans 'Title' %}</strong></label>
                <div class="ui fluid input field">
                    <input id="job_name" type="text" value="{{ initial.name }}">
                </div>
                <br>
                <label for="parent_identifier"><strong>{% trans 'Parent identifier' %}</strong></label>
                <div class="ui fluid input field">
                    <input id="parent_identifier" maxlength="36" type="text" value="{{ initial.parent }}">
                </div>
                {% if initial.preset_uuid %}
                    <input id="preset_uuid" type="hidden" value="{{ initial.preset_uuid }}">
                {% endif %}
            </div>

            {# Files table #}
            <div id="filestree">{% include 'jobs/fileTreeEdit.html' %}</div>

            {# Roles #}
            <div id="user_roles_form" style="margin-top: 10px;margin-bottom: 10px;">{% include 'jobs/userRolesForm.html' %}</div>

            {# Comment for editing job only #}
            {% if action == 'edit' %}
                <label for="job_comment"><strong>{% trans "Change comment" %}</strong></label>
                <div class="ui input fluid">
                    <input id="job_comment" type="text" placeholder="{% trans 'Comment' %}">
                </div>
            {% endif %}

            {# Action Buttons #}
            <br>
            <button id="save_job_btn" type="submit" class="ui olive button">{% trans 'Save' %}</button>
            <a href="{{ cancel_url }}" class="ui violet button" style="float: right">{% trans 'Cancel' %}</a>
        </div>
        <div id="editor_container" class="nine wide column">
            {# File editor #}
            {% include 'jobs/fileEditor.html' %}
        </div>
    </div>

    {# Warning modal for saving job without commiting file changes #}
    <div id="file_not_commited_modal" class="ui basic modal">
        <div class="ui icon header">
            <i class="warning sign icon"></i>
            {% trans 'Are you sure' %}?
        </div>
        <div class="content">
            <div class="ui center aligned grid"><p>{% trans 'The file you changed is not saved' %} (Ctrl+S)</p></div>
        </div>
        <div class="actions">
            <div class="ui center aligned grid">
                <button id="close_save_job_btn" type="button" class="ui blue basic inverted button">{% trans 'Cancel job saving' %}</button>
                <button id="confirm_save_job_btn" type="button" class="ui red basic inverted button">{% trans 'Save the job anyway' %}</button>
            </div>
        </div>
    </div>

    <script type="application/javascript">
        jQuery(function () {
            let job_form = new JobForm(),
                roles_form = new UserRoleForm('user_roles_form'),
                files_form = new FilesTree('filestree', 'editor_container');

            job_form.initialize({
                name: 'job_name',
                comment: 'job_comment',
                parent: 'parent_identifier',
                preset_uuid: 'preset_uuid'
            }, {
                name: "{% trans 'Title' %}",
                comment: "{% trans 'Change comment' %}",
                version: "{% trans 'Latest version' %}",
                parent: "{% trans 'Parent' %}"
            });

            files_form.set_messages({
                not_ascii: "{% trans 'Names with non-ASCII characters must be less than 30 characters' %}",
                title_required: "{% trans 'Title is required' %}",
                file_commited: "{% trans 'The file was commited' %}",
                file_not_commited: "{% trans 'The file was not commited' %}",
                file_required: "{% trans 'Please choose the file' %}"
            });
            files_form.set_labels({
                'new': "{% trans 'New' %}",
                'folder': "{% trans 'Folder' %}",
                'file': "{% trans 'File' %}",
                'upload': "{% trans 'Upload' %}",
                'rename': "{% trans 'Rename' %} (F2)",
                'delete': "{% trans 'Delete' %}",
                'replace': "{% trans 'Replace' %}",
                'download': "{% trans 'Download' %}"
            });

            function get_version_data(data_url) {
                $('#dimmer_of_page').addClass('active');
                $.get(data_url, {}, function (data) {
                    if (data.error) return err_notify(data.error);
                    roles_form.initialize(data['roles']);
                    files_form.initialize(data['files']);
                    {% if action == 'edit' %}
                        {# Get version name for editing job only #}
                        $('#job_name').val(data['name']);
                    {% endif %}
                    $('#dimmer_of_page').removeClass('active');
                });
            }

            function save_job() {
                job_form.save("{{ initial.save_url }}", "{% if action == 'edit' %}PUT{% else %}POST{% endif %}", {
                    global_role: roles_form.global_role(),
                    user_roles: roles_form.get_roles(),
                    files: files_form.serialize(),
                    version: {% if initial.version %}{{ initial.version }}{% else %}0{% endif %}
                });
            }

            get_version_data("{{ initial_url }}");

            $('#file_not_commited_modal').modal({transition: 'fade in', autofocus: false, closable: false});
            $('#close_save_job_btn').click(function () { $('#file_not_commited_modal').modal('hide') });
            $('#confirm_save_job_btn').click(save_job);

            $('#save_job_btn').click(function () {
                files_form.not_commited() ? $('#file_not_commited_modal').modal('show') : save_job();
            });

            // Update data on change job version if it exists
            let versions_selector = $('#job_version_selector');
            if (versions_selector.length) {
                versions_selector.dropdown();
                versions_selector.change(function () {
                    get_version_data(versions_selector.children('option:selected').val());
                });
            }
        });
    </script>
{% endblock %}
